name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run Build
        run: pnpm build

      - name: Publish to npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to GitHub Packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          pnpm publish --registry=https://npm.pkg.github.com --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commits between tags
        id: commits
        run: |
          # è·å–æœ€è¿‘ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
          TAGS=$(git tag -l 'v*' | sort -V | tail -n 2)
          FROM_TAG=$(echo "$TAGS" | head -n 1)
          TO_TAG=$(echo "$TAGS" | tail -n 1)

          echo "Comparing commits between $FROM_TAG and $TO_TAG"

          # è·å–æäº¤æ—¥å¿—å¹¶æ ¹æ®ç±»å‹æ ¼å¼åŒ–
          COMMITS=$(git log --oneline $FROM_TAG..$TO_TAG)

          # æ ¼å¼åŒ–å¹¶æŒ‰æäº¤ç±»å‹åˆ†ç»„
          FEAT_COMMITS=$(echo "$COMMITS" | grep -i "^feat" | sed 's/^feat/ğŸ‰ Feature:/')
          FIX_COMMITS=$(echo "$COMMITS" | grep -i "^fix" | sed 's/^fix/ğŸ Bug Fix:/')
          CHORE_COMMITS=$(echo "$COMMITS" | grep -i "^chore" | sed 's/^chore/ğŸ”§ Chore:/')
          DOC_COMMITS=$(echo "$COMMITS" | grep -i "^docs" | sed 's/^docs/ğŸ“š Documentation:/')

          # ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„ release note
          RELEASE_NOTES="## Changelog\n\n"
          RELEASE_NOTES="${RELEASE_NOTES}\n### Features\n${FEAT_COMMITS}\n"
          RELEASE_NOTES="${RELEASE_NOTES}\n### Bug Fixes\n${FIX_COMMITS}\n"
          RELEASE_NOTES="${RELEASE_NOTES}\n### Chores\n${CHORE_COMMITS}\n"
          RELEASE_NOTES="${RELEASE_NOTES}\n### Documentation\n${DOC_COMMITS}\n"

          # è¾“å‡º release notes ä½œä¸º action output
          echo "::set-output name=release_notes::$RELEASE_NOTES"

      - name: Generate Release Notes
        run: |
          echo "Release Notes for ${{ steps.commits.outputs.release_notes }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*
          release_notes: ${{ steps.commits.outputs.release_notes }}
